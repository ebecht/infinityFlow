<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Etienne Becht" />


<title>Basic usage of the infinityFlow package</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Basic usage of the infinityFlow package</h1>
<h4 class="author">Etienne Becht</h4>
<h4 class="date">June 2020</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Thank you for your interest in the <strong><em>Infinity Flow</em></strong> approach. This vignette describes how to apply the package to your massively parallel cytometry (e.g. <em>LEGENDScreen</em> or <em>Lyoplates kits</em>) experiment, using the default machine learning toolkit XGBoost. Other machine learning models are covered in a separate vignette.</p>
<p>This vignette will cover:</p>
<ol style="list-style-type: decimal">
<li>Package installation</li>
<li>Setting up your input data</li>
<li>Specifying the Backbone and Infinity antibodies</li>
<li>Running the Infinity Flow computational pipeline</li>
<li>Description of the output</li>
</ol>
</div>
<div id="package-installation" class="section level1">
<h1>Package installation</h1>
<p>You can install the latest version from github using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(<span class="op">!</span><span class="kw">require</span>(devtools)){
    <span class="kw">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)
}
<span class="cf">if</span>(<span class="op">!</span><span class="kw">require</span>(infinityFlow)){
    <span class="kw">library</span>(devtools)
    <span class="kw">install_github</span>(<span class="st">&quot;ebecht/infinityFlow&quot;</span>)
}</code></pre></div>
</div>
<div id="setting-up-your-input-data" class="section level1">
<h1>Setting up your input data</h1>
<p>Now that the package is installed, we load the package and attach its example data. We also load flowCore that will be used to manipulate FCS files in R.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(infinityFlow)
<span class="kw">data</span>(steady_state_lung)
<span class="kw">library</span>(flowCore)</code></pre></div>
<p>The example data is a subset of a massively parallel cytometry experiment of the mouse lung at steady state. The example data contains 10 FCS files, each with a distinct PE-conjugated Infinity antibody. To mimick real world-conditions, we will write this flowSet to disk as a set of 10 distinct FCS files. In this vignette we will use a temporary directory, but you can use the directory of your choice.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;infinity_flow_example&quot;</span>)
<span class="kw">print</span>(dir)
<span class="co">#&gt; [1] &quot;/tmp/RtmpqaubnW/infinity_flow_example&quot;</span>
input_dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(dir, <span class="st">&quot;fcs&quot;</span>)
<span class="kw">write.flowSet</span>(steady_state_lung, <span class="dt">outdir =</span> input_dir)
<span class="co">#&gt; [1] &quot;/tmp/RtmpqaubnW/infinity_flow_example/fcs&quot;</span>
<span class="kw">list.files</span>(input_dir)
<span class="co">#&gt;  [1] &quot;annotation.txt&quot;                      &quot;Plate1_Specimen_001_B12_B12_024.fcs&quot;</span>
<span class="co">#&gt;  [3] &quot;Plate1_Specimen_001_D8_D08_044.fcs&quot;  &quot;Plate1_Specimen_001_H11_H11_095.fcs&quot;</span>
<span class="co">#&gt;  [5] &quot;Plate3_Specimen_001_A3_A03_003.fcs&quot;  &quot;Plate3_Specimen_001_A9_A09_009.fcs&quot; </span>
<span class="co">#&gt;  [7] &quot;Plate3_Specimen_001_C11_C11_035.fcs&quot; &quot;Plate3_Specimen_001_C6_C06_030.fcs&quot; </span>
<span class="co">#&gt;  [9] &quot;Plate3_Specimen_001_E5_E05_053.fcs&quot;  &quot;Plate3_Specimen_001_F5_F05_065.fcs&quot; </span>
<span class="co">#&gt; [11] &quot;Plate3_Specimen_001_G2_G02_074.fcs&quot;</span></code></pre></div>
<p>The second input we have to manually produce is the annotation of the experiment. In the context of a massively parallel cytometry experiment, we need to know what is the protein target of each Infinity antibody, and what is its isotype. For the example dataset, the annotation is provided in the package and looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(steady_state_lung_annotation)
<span class="kw">print</span>(steady_state_lung_annotation)
<span class="co">#&gt;                                     Infinity_target Infinity_isotype</span>
<span class="co">#&gt; Plate1_Specimen_001_B12_B12_024.fcs            CD28            SHIgG</span>
<span class="co">#&gt; Plate1_Specimen_001_D8_D08_044.fcs    CD49b(pan-NK)             rIgM</span>
<span class="co">#&gt; Plate1_Specimen_001_H11_H11_095.fcs           CD137            SHIgG</span>
<span class="co">#&gt; Plate3_Specimen_001_A3_A03_003.fcs            KLRG1            SHIgG</span>
<span class="co">#&gt; Plate3_Specimen_001_A9_A09_009.fcs     Ly-49c/F/I/H            SHIgG</span>
<span class="co">#&gt; Plate3_Specimen_001_C6_C06_030.fcs       Podoplanin            SHIgG</span>
<span class="co">#&gt; Plate3_Specimen_001_C11_C11_035.fcs          SSEA-3             rIgM</span>
<span class="co">#&gt; Plate3_Specimen_001_E5_E05_053.fcs          TCR Vg3            SHIgG</span>
<span class="co">#&gt; Plate3_Specimen_001_F5_F05_065.fcs            SHIgG            SHIgG</span>
<span class="co">#&gt; Plate3_Specimen_001_G2_G02_074.fcs             rIgM             rIgM</span></code></pre></div>
<p>The <code>steady_state_lung_annotation</code> data.frame contains one line per FCS file, with <code>rownames(steady_state_lung_annotation) == sampleNames(steady_state_lung)</code>. The first column specifies the proteins targeted by the Infinity antibody in each FCS file, and the second column specifies its isotype (species and constant region of the antibody).</p>
<p>That is all we need in terms of inputs! To recap you only need</p>
<ol style="list-style-type: decimal">
<li>a folder with FCS files from your massively parallel cytometry experiment.</li>
<li>a table specifying the antibody targets and antibody isotypes for the Infinity antibodies from your massively parallel cytometry experiment.</li>
</ol>
</div>
<div id="specifying-the-backbone-and-infinity-antibodies" class="section level1">
<h1>Specifying the Backbone and Infinity antibodies</h1>
<p>Now that we have our input data, we need to specify which antibodies are part of the Backbone, and which one is the Infinity antibody. We provide an interactive function to specify this directly in R. This function can be run once, its output saved for future use by downstream functions in the <strong><em>infinityFlow</em></strong> package. The <code>select_backbone_and_exploratory_markers</code> function will parse an FCS file in the input directory, and for each acquisition channel, ask the user whether it should be used as a predictor (Backbone), exploratory target (Infinity antibodies), or omitted (e.g. Time or Event ID columns...).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">backbone_specification &lt;-<span class="st"> </span><span class="kw">select_backbone_and_exploratory_markers</span>(<span class="kw">list.files</span>(input_dir, <span class="dt">pattern =</span> <span class="st">&quot;.fcs&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>))</code></pre></div>
<p>Below is an example of the interactive execution of the <code>select_backbone_and_exploratory_markers</code> function for the example data. The resulting data.frame is printed too.</p>
<pre><code>For each data channel, enter either: backbone, exploratory or discard (can be abbreviated)
FSC-A (FSC-A):discard
FSC-H (FSC-H):backbone
FSC-W (FSC-W):b
SSC-A (SSC-A):d
SSC-H (SSC-H):b
SSC-W (SSC-W):b
CD69-CD301b (FJComp-APC-A):b
Zombie (FJComp-APC-eFlour780-A):b
MHCII (FJComp-Alexa Fluor 700-A):b
CD4 (FJComp-BUV395-A):b
CD44 (FJComp-BUV737-A):b
CD8 (FJComp-BV421-A):b
CD11c (FJComp-BV510-A):b
CD11b (FJComp-BV605-A):b
F480 (FJComp-BV650-A):b
Ly6C (FJComp-BV711-A):b
Lineage (FJComp-BV786-A):b
CD45a488 (FJComp-GFP-A):b
Legend (FJComp-PE(yg)-A):exploratory
CD24 (FJComp-PE-Cy7(yg)-A):b
CD103 (FJComp-PerCP-Cy5-5-A):b
Time (Time):d
                         name        desc        type
$P1                     FSC-A        &lt;NA&gt;     discard
$P2                     FSC-H        &lt;NA&gt;    backbone
$P3                     FSC-W        &lt;NA&gt;    backbone
$P4                     SSC-A        &lt;NA&gt;     discard
$P5                     SSC-H        &lt;NA&gt;    backbone
$P6                     SSC-W        &lt;NA&gt;    backbone
$P7              FJComp-APC-A CD69-CD301b    backbone
$P8    FJComp-APC-eFlour780-A      Zombie    backbone
$P9  FJComp-Alexa Fluor 700-A       MHCII    backbone
$P10          FJComp-BUV395-A         CD4    backbone
$P11          FJComp-BUV737-A        CD44    backbone
$P12           FJComp-BV421-A         CD8    backbone
$P13           FJComp-BV510-A       CD11c    backbone
$P14           FJComp-BV605-A       CD11b    backbone
$P15           FJComp-BV650-A        F480    backbone
$P16           FJComp-BV711-A        Ly6C    backbone
$P17           FJComp-BV786-A     Lineage    backbone
$P18             FJComp-GFP-A    CD45a488    backbone
$P19          FJComp-PE(yg)-A      Legend exploratory
$P20      FJComp-PE-Cy7(yg)-A        CD24    backbone
$P21     FJComp-PerCP-Cy5-5-A       CD103    backbone
$P22                     Time        &lt;NA&gt;     discard
Is selection correct? (yes/no): yes</code></pre>
<p>We cannot run this function interactively from this vignette, so we load the result from the package instead:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(steady_state_lung_backbone_specification)
<span class="kw">print</span>(<span class="kw">head</span>(steady_state_lung_backbone_specification))
<span class="co">#&gt;    name desc     type</span>
<span class="co">#&gt; 1 FSC-A &lt;NA&gt;  discard</span>
<span class="co">#&gt; 2 FSC-H &lt;NA&gt; backbone</span>
<span class="co">#&gt; 3 FSC-W &lt;NA&gt; backbone</span>
<span class="co">#&gt; 4 SSC-A &lt;NA&gt;  discard</span>
<span class="co">#&gt; 5 SSC-H &lt;NA&gt; backbone</span>
<span class="co">#&gt; 6 SSC-W &lt;NA&gt; backbone</span></code></pre></div>
<p>You need to save this backbone specification file as a CSV file for future use.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(steady_state_lung_backbone_specification, <span class="dt">file =</span> <span class="kw">file.path</span>(dir, <span class="st">&quot;backbone_selection_file.csv&quot;</span>), <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</code></pre></div>
</div>
<div id="running-the-infinity-flow-computational-pipeline" class="section level1">
<h1>Running the Infinity Flow computational pipeline</h1>
<p>Now that we have our input data, FCS files annotation and specification of the Backbone and Infinity antibodies, we have everything we need to run the pipeline.</p>
<p>All the pipeline is packaged into a single function, <code>infinity_flow()</code>.</p>
<p>Here is a description of the basic arguments it requires:</p>
<ol style="list-style-type: decimal">
<li>path_to_fcs: path to the folder with input FCS files</li>
<li>path_to_output: path to a folder where the output will be saved.</li>
<li>backbone_selection_file: the CSV file specifying backbone and Infinity antibodies, created in the <em>Specifying the Backbone and Infinity antibodies</em> section above.</li>
<li>annotation: A named vector of Infinity antibody targets per FCS file. We will create it from the annotation table we created in the <em>Setting up your input data</em> section</li>
<li>isotype: Same as annotation, but specifying Infinity antibody isotypes rather than antibody targets.</li>
</ol>
<p>We have everything we need in our input folder to fill these arguments:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list.files</span>(dir)
<span class="co">#&gt; [1] &quot;backbone_selection_file.csv&quot; &quot;fcs&quot;</span></code></pre></div>
<p>First, input FCS files:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path_to_fcs &lt;-<span class="st"> </span><span class="kw">file.path</span>(dir, <span class="st">&quot;fcs&quot;</span>)
<span class="kw">head</span>(<span class="kw">list.files</span>(path_to_fcs, <span class="dt">pattern =</span> <span class="st">&quot;.fcs&quot;</span>))
<span class="co">#&gt; [1] &quot;Plate1_Specimen_001_B12_B12_024.fcs&quot; &quot;Plate1_Specimen_001_D8_D08_044.fcs&quot; </span>
<span class="co">#&gt; [3] &quot;Plate1_Specimen_001_H11_H11_095.fcs&quot; &quot;Plate3_Specimen_001_A3_A03_003.fcs&quot; </span>
<span class="co">#&gt; [5] &quot;Plate3_Specimen_001_A9_A09_009.fcs&quot;  &quot;Plate3_Specimen_001_C11_C11_035.fcs&quot;</span></code></pre></div>
<p>Output directory. It will be created if it doesn't already exist</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path_to_output &lt;-<span class="st"> </span><span class="kw">file.path</span>(dir, <span class="st">&quot;output&quot;</span>)</code></pre></div>
<p>Backbone selection file:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list.files</span>(dir)
<span class="co">#&gt; [1] &quot;backbone_selection_file.csv&quot; &quot;fcs&quot;</span>
backbone_selection_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(dir, <span class="st">&quot;backbone_selection_file.csv&quot;</span>)
<span class="kw">head</span>(<span class="kw">read.csv</span>(backbone_selection_file))
<span class="co">#&gt;    name desc     type</span>
<span class="co">#&gt; 1 FSC-A &lt;NA&gt;  discard</span>
<span class="co">#&gt; 2 FSC-H &lt;NA&gt; backbone</span>
<span class="co">#&gt; 3 FSC-W &lt;NA&gt; backbone</span>
<span class="co">#&gt; 4 SSC-A &lt;NA&gt;  discard</span>
<span class="co">#&gt; 5 SSC-H &lt;NA&gt; backbone</span>
<span class="co">#&gt; 6 SSC-W &lt;NA&gt; backbone</span></code></pre></div>
<p>Annotation of Infinity antibody targets and isotypes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">targets &lt;-<span class="st"> </span>steady_state_lung_annotation<span class="op">$</span>Infinity_target
<span class="kw">names</span>(targets) &lt;-<span class="st"> </span><span class="kw">rownames</span>(steady_state_lung_annotation)
isotypes &lt;-<span class="st"> </span>steady_state_lung_annotation<span class="op">$</span>Infinity_isotype
<span class="kw">names</span>(isotypes) &lt;-<span class="st"> </span><span class="kw">rownames</span>(steady_state_lung_annotation)
<span class="kw">head</span>(targets)
<span class="co">#&gt; Plate1_Specimen_001_B12_B12_024.fcs  Plate1_Specimen_001_D8_D08_044.fcs </span>
<span class="co">#&gt;                              &quot;CD28&quot;                     &quot;CD49b(pan-NK)&quot; </span>
<span class="co">#&gt; Plate1_Specimen_001_H11_H11_095.fcs  Plate3_Specimen_001_A3_A03_003.fcs </span>
<span class="co">#&gt;                             &quot;CD137&quot;                             &quot;KLRG1&quot; </span>
<span class="co">#&gt;  Plate3_Specimen_001_A9_A09_009.fcs  Plate3_Specimen_001_C6_C06_030.fcs </span>
<span class="co">#&gt;                      &quot;Ly-49c/F/I/H&quot;                        &quot;Podoplanin&quot;</span>
<span class="kw">head</span>(isotypes)
<span class="co">#&gt; Plate1_Specimen_001_B12_B12_024.fcs  Plate1_Specimen_001_D8_D08_044.fcs </span>
<span class="co">#&gt;                             &quot;SHIgG&quot;                              &quot;rIgM&quot; </span>
<span class="co">#&gt; Plate1_Specimen_001_H11_H11_095.fcs  Plate3_Specimen_001_A3_A03_003.fcs </span>
<span class="co">#&gt;                             &quot;SHIgG&quot;                             &quot;SHIgG&quot; </span>
<span class="co">#&gt;  Plate3_Specimen_001_A9_A09_009.fcs  Plate3_Specimen_001_C6_C06_030.fcs </span>
<span class="co">#&gt;                             &quot;SHIgG&quot;                             &quot;SHIgG&quot;</span></code></pre></div>
<p>Other arguments are optional, but it is notably worth considering the number of input cells and the number of output cells. This will notably be important if you are using a computer with limited RAM. For the example data it does not matter as we only have access to 2,000 cells per well, but if you run the pipeline on your own data I suggest you start by low values, and ramp up (to 20,000 or 50,000 input cells, and e.g. 10,000 output cells per well) once everything is setup. Another optional argument is <code>cores</code> which controls multicore computing, which can speed up execution at the cost of memory usage. In this vignette we use cores = 1, but you probably want to increase this to 4 or 8 or more if your computer can accomodate it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">input_events_downsampling &lt;-<span class="st"> </span><span class="dv">1000</span>
prediction_events_downsampling &lt;-<span class="st"> </span><span class="dv">500</span>
cores =<span class="st"> </span>1L</code></pre></div>
<p>There is also an argument to store temporary files, which can be useful to further analyze the data in R. If missing, this argument will default to a temporary directory.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path_to_intermediary_results &lt;-<span class="st"> </span><span class="kw">file.path</span>(dir, <span class="st">&quot;tmp&quot;</span>)</code></pre></div>
<p>At last, now let us execute the pipeline:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">imputed_data &lt;-<span class="st"> </span><span class="kw">infinity_flow</span>(
    <span class="dt">path_to_fcs =</span> path_to_fcs,
    <span class="dt">path_to_output =</span> path_to_output,
    <span class="dt">path_to_intermediary_results =</span> path_to_intermediary_results,
    <span class="dt">backbone_selection_file =</span> backbone_selection_file,
    <span class="dt">annotation =</span> targets,
    <span class="dt">isotype =</span> isotypes,
    <span class="dt">input_events_downsampling =</span> input_events_downsampling,
    <span class="dt">prediction_events_downsampling =</span> prediction_events_downsampling,
    <span class="dt">verbose =</span> <span class="ot">TRUE</span>,
    <span class="dt">cores =</span> cores
)
<span class="co">#&gt; /tmp/RtmpqaubnW/infinity_flow_example/tmp and /tmp/RtmpqaubnW/infinity_flow_example/tmp/subsetted_fcs and /tmp/RtmpqaubnW/infinity_flow_example/tmp/rds and /tmp/RtmpqaubnW/infinity_flow_example/output: directories not found, creating directory(ies)</span>
<span class="co">#&gt; Using directories...</span>
<span class="co">#&gt;  input: /tmp/RtmpqaubnW/infinity_flow_example/fcs</span>
<span class="co">#&gt;  intermediary: /tmp/RtmpqaubnW/infinity_flow_example/tmp</span>
<span class="co">#&gt;  subset: /tmp/RtmpqaubnW/infinity_flow_example/tmp/subsetted_fcs</span>
<span class="co">#&gt;  rds: /tmp/RtmpqaubnW/infinity_flow_example/tmp/rds</span>
<span class="co">#&gt;  annotation: /tmp/RtmpqaubnW/infinity_flow_example/tmp/annotation.csv</span>
<span class="co">#&gt;  output: /tmp/RtmpqaubnW/infinity_flow_example/output</span>
<span class="co">#&gt; Parsing and subsampling input data</span>
<span class="co">#&gt;  Downsampling to 1000 events per input file</span>
<span class="co">#&gt;  Concatenating expression matrices</span>
<span class="co">#&gt;  Writing to disk</span>
<span class="co">#&gt; Logicle-transforming the data</span>
<span class="co">#&gt;  Backbone data</span>
<span class="co">#&gt;  Exploratory data</span>
<span class="co">#&gt;  Writing to disk</span>
<span class="co">#&gt;  Transforming expression matrix</span>
<span class="co">#&gt;  Writing to disk</span>
<span class="co">#&gt; Harmonizing backbone data</span>
<span class="co">#&gt;  Scaling expression matrices</span>
<span class="co">#&gt;  Writing to disk</span>
<span class="co">#&gt; Fitting regression models</span>
<span class="co">#&gt;  Randomly selecting 50% of the subsetted input files to fit models</span>
<span class="co">#&gt;  Fitting...</span>
<span class="co">#&gt;      XGBoost</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  7.912858 seconds</span>
<span class="co">#&gt; Imputing missing measurements</span>
<span class="co">#&gt;  Randomly drawing events to predict from the test set</span>
<span class="co">#&gt;  Imputing...</span>
<span class="co">#&gt;      XGBoost</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  1.890237 seconds</span>
<span class="co">#&gt;  Concatenating predictions</span>
<span class="co">#&gt;  Writing to disk</span>
<span class="co">#&gt; Performing dimensionality reduction</span>
<span class="co">#&gt; 15:52:51 UMAP embedding parameters a = 1.262 b = 1.003</span>
<span class="co">#&gt; 15:52:51 Read 5000 rows and found 17 numeric columns</span>
<span class="co">#&gt; 15:52:51 Using Annoy for neighbor search, n_neighbors = 15</span>
<span class="co">#&gt; 15:52:52 Building Annoy index with metric = euclidean, n_trees = 50</span>
<span class="co">#&gt; 0%   10   20   30   40   50   60   70   80   90   100%</span>
<span class="co">#&gt; [----|----|----|----|----|----|----|----|----|----|</span>
<span class="co">#&gt; **************************************************|</span>
<span class="co">#&gt; 15:52:52 Writing NN index file to temp file /tmp/RtmpqaubnW/file39686c4b54f9</span>
<span class="co">#&gt; 15:52:52 Searching Annoy index using 1 thread, search_k = 1500</span>
<span class="co">#&gt; 15:52:53 Annoy recall = 100%</span>
<span class="co">#&gt; 15:52:54 Commencing smooth kNN distance calibration using 1 thread</span>
<span class="co">#&gt; 15:52:54 Initializing from normalized Laplacian + noise</span>
<span class="co">#&gt; 15:52:54 Commencing optimization for 1000 epochs, with 101742 positive edges using 1 thread</span>
<span class="co">#&gt; 15:53:04 Optimization finished</span>
<span class="co">#&gt; Exporting results</span>
<span class="co">#&gt;  Transforming predictions back to a linear scale</span>
<span class="co">#&gt;  Exporting FCS files (1 per well)</span>
<span class="co">#&gt; Plotting</span>
<span class="co">#&gt;  Chopping off the top and bottom 0.005 quantiles</span>
<span class="co">#&gt;  Shuffling the order of cells (rows)</span>
<span class="co">#&gt;  Producing plot</span>
<span class="co">#&gt; Background correcting</span>
<span class="co">#&gt;  Transforming background-corrected predictions. (Use logarithm to visualize)</span>
<span class="co">#&gt;  Exporting FCS files (1 per well)</span>
<span class="co">#&gt; Plotting</span>
<span class="co">#&gt;  Chopping off the top and bottom 0.005 quantiles</span>
<span class="co">#&gt;  Shuffling the order of cells (rows)</span>
<span class="co">#&gt;  Producing plot</span></code></pre></div>
<p>The above command populated our output directory with new sets of files which we describe in the next section.</p>
</div>
<div id="description-of-the-output" class="section level1">
<h1>Description of the output</h1>
<p>The output mainly consists of</p>
<ol style="list-style-type: decimal">
<li>Sets of FCS files with imputed data, which can be used for further downstream analysis.</li>
<li>PDFs of a UMAP embedding of the Backbone data, color-coded by imputed expression of the Infinity antibody</li>
</ol>
<p>Each of the above comes in two flavours, either <strong>raw</strong> or <strong>background-corrected</strong>.</p>
<p>At the end of the pipeline, input FCS files are augmented with imputed data. Feel free to explore these files in whatever flow cytometry software you are comfortable with! They should look pretty much like regular FCS files, although they are computationnally derived. You can find the output FCS files in the <code>path_to_output</code> directory, specifically:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(<span class="kw">list.files</span>(path_to_fcs)) ## Input files
<span class="co">#&gt; [1] &quot;annotation.txt&quot;                      &quot;Plate1_Specimen_001_B12_B12_024.fcs&quot;</span>
<span class="co">#&gt; [3] &quot;Plate1_Specimen_001_D8_D08_044.fcs&quot;  &quot;Plate1_Specimen_001_H11_H11_095.fcs&quot;</span>
<span class="co">#&gt; [5] &quot;Plate3_Specimen_001_A3_A03_003.fcs&quot;  &quot;Plate3_Specimen_001_A9_A09_009.fcs&quot;</span>
fcs_raw &lt;-<span class="st"> </span><span class="kw">file.path</span>(path_to_output, <span class="st">&quot;FCS&quot;</span>, <span class="st">&quot;split&quot;</span>)
<span class="kw">head</span>(<span class="kw">list.files</span>(fcs_raw)) ## Raw output FCS files
<span class="co">#&gt; [1] &quot;Plate1_Specimen_001_B12_B12_024_target_CD28.fcs&quot;        </span>
<span class="co">#&gt; [2] &quot;Plate1_Specimen_001_D8_D08_044_target_CD49b(pan-NK).fcs&quot;</span>
<span class="co">#&gt; [3] &quot;Plate1_Specimen_001_H11_H11_095_target_CD137.fcs&quot;       </span>
<span class="co">#&gt; [4] &quot;Plate3_Specimen_001_A3_A03_003_target_KLRG1.fcs&quot;        </span>
<span class="co">#&gt; [5] &quot;Plate3_Specimen_001_A9_A09_009_target_Ly-49c-F-I-H.fcs&quot; </span>
<span class="co">#&gt; [6] &quot;Plate3_Specimen_001_C11_C11_035_target_SSEA-3.fcs&quot;</span>
fcs_bgc &lt;-<span class="st"> </span><span class="kw">file.path</span>(path_to_output, <span class="st">&quot;FCS_background_corrected&quot;</span>, <span class="st">&quot;split&quot;</span>) ## Background-corrected output FCS files
<span class="kw">head</span>(<span class="kw">list.files</span>(fcs_bgc)) ## Background-corrected output FCS files
<span class="co">#&gt; [1] &quot;Plate1_Specimen_001_B12_B12_024_target_CD28.fcs&quot;        </span>
<span class="co">#&gt; [2] &quot;Plate1_Specimen_001_D8_D08_044_target_CD49b(pan-NK).fcs&quot;</span>
<span class="co">#&gt; [3] &quot;Plate1_Specimen_001_H11_H11_095_target_CD137.fcs&quot;       </span>
<span class="co">#&gt; [4] &quot;Plate3_Specimen_001_A3_A03_003_target_KLRG1.fcs&quot;        </span>
<span class="co">#&gt; [5] &quot;Plate3_Specimen_001_A9_A09_009_target_Ly-49c-F-I-H.fcs&quot; </span>
<span class="co">#&gt; [6] &quot;Plate3_Specimen_001_C11_C11_035_target_SSEA-3.fcs&quot;</span></code></pre></div>
<p>Finally, the pipeline produces two PDF files, with a UMAP embedding of the backbone data color-coded by the imputed data. This is a very informative output and a good way to start analyzing your data. These files are present in the <code>path_to_output</code> directory. The example dataset is very small but feel free to look at the result for illustration purposes. This PDF is available at</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">file.path</span>(path_to_output, <span class="st">&quot;umap_plot_annotated.pdf&quot;</span>) ## Raw plot
<span class="co">#&gt; [1] &quot;/tmp/RtmpqaubnW/infinity_flow_example/output/umap_plot_annotated.pdf&quot;</span>
<span class="kw">file.path</span>(path_to_output, <span class="st">&quot;umap_plot_annotated_backgroundcorrected.pdf&quot;</span>) ## Background-corrected plot
<span class="co">#&gt; [1] &quot;/tmp/RtmpqaubnW/infinity_flow_example/output/umap_plot_annotated_backgroundcorrected.pdf&quot;</span></code></pre></div>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>Thank you for following this vignette, I hope you made it through the end without too much headache and that it was informative. Feel free to raise an issue on infinityFlow's [github]{<a href="https://github.com/ebecht/infinityFlow/issues" class="uri">https://github.com/ebecht/infinityFlow/issues</a>} if you run into unsolvable issues.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
